<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/defaultLayout}">
<div class="container-fluid px-4" layout:fragment="content">
    <script th:inline="javascript">
        window.onload = function () {
            const putForm = document.getElementById('putForm');
            const commentForm = document.getElementById('commentForm');
            const btnComment = document.getElementsByClassName('btnComment')[0];
            const articleModify = document.getElementById('articleModify');
            const articleDelete = document.getElementById('articleDelete');

            const fileLinks = document.getElementsByClassName('fileLink');

            for (const fileLink of fileLinks) {
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­ê³¼ ë™ì‹œì— ë‹¤ìš´ë¡œë“œ ì¹´ìš´íŠ¸ ìš”ì²­
                fileLink.onclick = async function () {
                    const fno = this.dataset.fno;

                    const count = this.nextElementSibling.innerText;
                    this.nextElementSibling.innerHTML = parseInt(count) + 1;
                }
            }

            //////////////////////////////////////////////////////////////////////////
            // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
            //////////////////////////////////////////////////////////////////////////
            const commentContainer = document.getElementById('commentContainer');
            const commentPlaceholder = document.getElementById('commentPlaceholder');
            const parent = [[${article.no}]];
            console.log(parent);

            const thisUser = putForm.user.value;
            setTimeout(async function () {

                console.log('here...1');

                const comments = await fetchGet(`/sboard/comment/${parent}`);
                console.log('here...2 : ' + comments);

                if (comments.length > 0) {
                    for (const comment of comments) {
                        commentPlaceholder.remove();
                        let commentArticle = "";
                        const commentTop = `
                        <div class="card mt-3 comment" id="comment">
                             <div class="card-body">
                                 <div class="d-flex flex-start">
                                     <i class="fas fa-user mt-1 me-2 fs-5" ></i>
                                     <div class="w-100">
                                         <div class="d-flex justify-content-between align-items-center mb-3">
                                             <h6 class="text-primary fw-bold mb-0">
                                                 ${comment.nick}
                                                 <span class="text-dark ms-2"></span>
                                             </h6>
                                             <div class="ml-auto">
                                                 <p class="mb-0">${comment.rdate.substring(0, 10)}</p>
                                             </div>
                                         </div>
                                         <div class="d-flex justify-content-between align-items-center mb-3">
                                                 <textarea class="form-control" rows="3" readonly>${comment.content}</textarea>
                                         </div>
                                         <div class="float-end">
                                              <div class="d-flex flex-row">
                                                 <button class="btn btn-light btn-sm fw-bold" id="iLikeComment" data-like="commentlike" data-no="${comment.no}"><i class="fas fa-star text-warning me-2 fs-5"></i>${comment.heart}</button>
                                             </div>
                                         </div>
                                          <div class="d-flex justify-content-between align-items-center">`;

                        <!-- ëŒ“ê¸€ ì‘ì„±ìì™€ í˜„ì¬ ì‚¬ìš©ìê°€ ë™ì¼í•œ ê²½ìš°ì—ë§Œ ì‚­ì œ ë° ìˆ˜ì • ë²„íŠ¼ì„ í‘œì‹œ -->
                        const commentBtn = `

                                             <p class="small mb-0" style="color: #aaa;">
                                                     <a href="#" class="link-grey btnModify" data-mode="modify" data-no="${comment.no}"><i class="bi bi-pencil-fill"></i> ìˆ˜ì •</a> â€¢
                                                     <a href="#" class="link-grey btnRemove" data-mode="remove" data-no="${comment.no}"><i class="bi bi-trash3-fill"></i> ì‚­ì œ</a>
                                             </p>
                                             `;
                        const commentEnd = `
                                         </div>

                                     </div>
                                 </div>
                                 </div>
                             </div>`;

                        if (comment.writer === thisUser) {
                            commentArticle = commentTop + commentBtn + commentEnd;
                        } else {
                            commentArticle = commentTop + commentEnd;
                        }
                        // íƒœê·¸ ë¬¸ìì—´ ì‚½ì…
                        commentContainer.insertAdjacentHTML('beforeend', commentArticle);
                    }
                } else {
                    commentPlaceholder.remove();
                    const commentHtml = `
                                <div class="card mt-3 comment" id="noComment">
                                        <div class="card-body">
                                            <div class="d-flex flex-start">
                                                <div class="w-100">
                                                    <div class="d-flex justify-content-between align-items-center text-center mb-3">
                                                         <h4 class="text-primary fw-bold mb-0">

                                                            <span class="text-dark ms-2">
                                                            ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥
                                                              ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.
                                                            </span>
                                                        </h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        </div>`;
                    console.log(commentHtml);

                    commentContainer.insertAdjacentHTML('beforeend', commentHtml);
                }
            }, 1000);
            //////////////////////////////////////////////////////////////////////////
            // ëŒ“ê¸€ ë“±ë¡
            //////////////////////////////////////////////////////////////////////////
            commentForm.onsubmit = async function (e) {

                const pg = commentForm.querySelector('input[name="pg"]').value;
                const parent = commentForm.querySelector('input[name="parent"]').value;
                const url = `/sboard/comment?page=${pg}`;
                const nick = [[${#authentication.principal.user.nick}]];
                e.preventDefault();
                const jsonData = {
                    "writer": commentForm.querySelector('input[name="writer"]').value,
                    "cate": commentForm.querySelector('input[name="cate"]').value,
                    "parent": parent,
                    "content": commentForm.content.value
                };
                console.log(jsonData);
                const data = await fetchPost(url, jsonData);
                console.log(data);
                const noComment = document.getElementById('noComment');
                if (noComment) {
                    noComment.remove();
                }
                // ëŒ“ê¸€ ëª©ë¡ ë™ì  ì²˜ë¦¬
                const commentHtml = `
                                <div class="card mt-3 comment " id="comment">
                                        <div class="card-body">
                                            <div class="d-flex flex-start">
                                                <i class="fas fa-user mt-1 me-2 fs-5"></i>
                                                <div class="w-100">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <h6 class="text-primary fw-bold mb-0">
                                                            ${nick}
                                                            <span class="text-dark ms-2"></span>
                                                        </h6>
                                                        <div class="ml-auto">
                                                            <p class="mb-0">${data.rdate.substring(0, 10)}</p>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                         <textarea class="form-control" rows="3" readonly>${data.content}</textarea>
                                                    </div>
                                                    <div class="float-end">
                                                          <div class="d-flex flex-row">
                                                             <button class="btn btn-light btn-sm fw-bold" data-like="commentlike" data-no="${data.no}"><i class="fas fa-star text-warning me-2 fs-5"></i>${comment.heart}</button>
                                                         </div>
                                                     </div>
                                                    <!-- ëŒ“ê¸€ ì‘ì„±ìì™€ í˜„ì¬ ì‚¬ìš©ìê°€ ë™ì¼í•œ ê²½ìš°ì—ë§Œ ì‚­ì œ ë° ìˆ˜ì • ë²„íŠ¼ì„ í‘œì‹œ -->
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <p class="small mb-0" style="color: #aaa;">
                                                                 <a href="#" class="link-grey btnModify" data-mode="modify" data-no="${data.no}"><i class="bi bi-pencil-fill"></i> ìˆ˜ì •</a> â€¢
                                                                 <a href="#" class="link-grey btnRemove" data-mode="remove" data-no="${data.no}"><i class="bi bi-trash3-fill"></i> ì‚­ì œ</a>
                                                         </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        </div>
                                    `;
                console.log(commentHtml);
                commentForm.content.value = "";
                commentContainer.insertAdjacentHTML('beforeend', commentHtml);
            };
            //////////////////////////////////////////////////////////////////////////
            // ëŒ“ê¸€ ì‚­ì œ ìˆ˜ì •
            //////////////////////////////////////////////////////////////////////////
            document.addEventListener('click', async function (e) {

                // ë‹¤ë¥¸ í˜ì´ì§€ ì´ë™, ëŒ“ê¸€ ë“±ë¡ ë“±ì€ ì œì™¸ í•´ì•¼í•¨
                if (e.target.tagName === 'A' && e.target.dataset.mode != null) {
                    e.preventDefault();

                    // ì‚­ì œ
                    if (e.target.dataset.mode == 'remove') {
                        const comment = e.target.closest('.comment');
                        const no = e.target.dataset.no;

                        console.log("no : " + no);

                        const data = await fetchDelete(`/sboard/comment/${no}`);
                        if (data) {
                            alertModal("ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            comment.remove();
                        }
                    } else if (e.target.dataset.mode == 'modify') {
                        const comment = e.target.closest('.comment');
                        const btnModify = comment.getElementsByClassName('btnModify')[0];
                        const btnRemove = comment.getElementsByClassName('btnRemove')[0];
                        const no = e.target.dataset.no;
                        const textarea = comment.getElementsByTagName('textarea')[0];

                        // ìˆ˜ì • ëª¨ë“œ
                        textarea.readOnly = false;
                        textarea.style.outline = "1px solid #111"
                        textarea.focus();
                        textarea.setSelectionRange(textarea.value.length, textarea.value.length);

                        btnModify.textContent = 'ìˆ˜ì •';
                        btnModify.dataset.mode = 'update';
                        btnRemove.textContent = 'ì·¨ì†Œ';
                        btnRemove.dataset.mode = 'cancel';

                    } else if (e.target.dataset.mode == 'cancel') {
                        alertModal('ìˆ˜ì • ì·¨ì†Œ');
                        const comment = e.target.closest('.comment');

                        // ìˆ˜ì • ëª¨ë“œ í•´ì œ í•¨ìˆ˜
                        noModifyMode(comment);

                    } else if (e.target.dataset.mode == 'update') {
                        const comment = e.target.closest('.comment');
                        const btnModify = comment.getElementsByClassName('btnModify')[0];
                        const btnRemove = comment.getElementsByClassName('btnRemove')[0];
                        const textarea = comment.getElementsByTagName('textarea')[0];
                        const no = e.target.dataset.no;

                        const jsonData = {
                            "no": no,
                            "content": textarea.value
                        };

                        console.log(jsonData);

                        const data = await fetchPut('/sboard/comment', jsonData);

                        alertModal("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

                        noModifyMode(comment);
                    } else if (e.target.dataset.mode == 'return') {
                        const cate = putForm.cate.value;
                        const pg = putForm.pg.value;
                        window.location.href = '/sboard/article/list?pg=' + pg + '&cate=' + cate;

                    }

                    //////////////////////////////////////////////////////////////////////////
                    // ê²Œì‹œê¸€ ìˆ˜ì • ì‚­ì œ
                    //////////////////////////////////////////////////////////////////////////
                }else if(e.target.tagName === 'BUTTON'){
                    const fileUpload = document.getElementById('fileUpload');
                    const contentTextarea = document.getElementById('articleFormControlTextarea1');
                    const roundedPills = document.getElementsByClassName('rounded-pill');
                    const removeFiles = document.getElementsByClassName('removeFile');
                    const no = putForm.no.value;
                    const cate = putForm.cate.value;

                    // ê²Œì‹œê¸€ ìˆ˜ì • //////////////////////////////////////////////////////////////////////////
                    if(e.target.id === 'articleModify' && e.target.dataset.mode === 'modify') {

                        // ìˆ˜ì • ëª¨ë“œ
                        contentTextarea.readOnly = false;
                        fileUpload.classList.remove('visually-hidden');

                        articleDelete.innerText = 'ì·¨ì†Œ';
                        articleModify.innerText = 'ìˆ˜ì •ì™„ë£Œ';
                        articleDelete.dataset.mode = 'artCancel';
                        e.target.dataset.mode = 'submit';
                        for (const roundedPill of roundedPills) {
                            roundedPill.classList.add('visually-hidden');
                        }
                        for (const removeFile of removeFiles) {
                            removeFile.classList.remove('visually-hidden');
                        }

                    }else if(e.target.id === 'articleModify' && e.target.dataset.mode === 'submit') {
                        e.preventDefault();
                        const putForm = document.getElementById('putForm');

                        putForm.submit();

                        // fileì€ jsonì— í¬í•¨ë  ìˆ˜ ì—†ë‹¤.


                        alertModal("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

                        contentTextarea.readOnly = true;
                        fileUpload.classList.add('visually-hidden');
                        removeFiles.classList.add('visually-hidden');
                        articleDelete.innerText = 'ì‚­ì œ';
                        e.target.dataset.mode = 'modify';

                        // ê²Œì‹œê¸€ ì‚­ì œ //////////////////////////////////////////////////////////////////////////
                    }else if(e.target.id === 'articleDelete'){

                        if(articleDelete.innerText === 'ì‚­ì œ') {
                            if (await confirmModal('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {

                                const data = await fetchDelete(`/sboard/article/${no}`);
                                if (data) {
                                    alertModal("ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                    location.href = '/sboard/article/list?cate=' + cate;
                                }
                            }
                            // ê²Œì‹œê¸€ ìˆ˜ì • ì·¨ì†Œ //////////////////////////////////////////////////////////////////////
                        }else if(articleDelete.innerText === 'ì·¨ì†Œ'){
                            if (await confirmModal('ê²Œì‹œê¸€ì„ ìˆ˜ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                contentTextarea.readOnly = true;
                                fileUpload.classList.add('visually-hidden');
                                removeFiles.classList.add('visually-hidden');
                                articleDelete.innerText = 'ì‚­ì œ';
                                e.target.dataset.mode = 'modify';
                            }
                        }
                        // ê²Œì‹œê¸€ ì¢‹ì•„ìš”
                    }else if(e.target.id === 'iLikeIt') {
                        e.preventDefault();
                        const iLikeIt = document.getElementById('iLikeIt');
                        const no = putForm.no.value;
                        const uid = commentForm.writer.value;
                        const jsonData ={
                            "uid" : uid,
                            "no"  : no
                        };
                        const data = await fetchPost('/sboard/heart', jsonData);

                        if(data != null){
                            iLikeIt.innerHTML = `<i class="bi bi-hand-thumbs-up-fill"></i> ì¶”ì²œ ${data.heart}`;
                        }else {
                            if(await confirmModal('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
                                const delData = await fetchDelete(`/sboard/heart/${uid}/${no}`);
                                iLikeIt.innerHTML = `<i class="bi bi-hand-thumbs-up-fill fs-5"></i> ì¶”ì²œ ${delData.heart}`;
                            }
                        }
                        // ëŒ“ê¸€ ì¢‹ì•„ìš”
                    }else if(e.target.dataset.like === 'commentlike') {
                        e.preventDefault();
                        const iLikeComment = e.target;
                        const no = e.target.dataset.no;
                        const uid = commentForm.writer.value;
                        const jsonData ={
                            "uid" : uid,
                            "no"  : no
                        };
                        const data = await fetchPost('/sboard/heart', jsonData);

                        if(data != null){
                            iLikeComment.innerHTML = `<i class="fas fa-star text-warning me-2 fs-5"></i>${data.heart}`;
                        }else {
                            if(await confirmModal('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
                                const delData = await fetchDelete(`/sboard/heart/${uid}/${no}`);
                                iLikeComment.innerHTML = `<i class="fas fa-star text-warning me-2 fs-5"></i>${delData.heart}`;
                            }
                        }
                    }
                    // íŒŒì¼ ì‚­ì œ í´ë¦­
                }if (e.target.tagName === 'A' && e.target.dataset.fno != null) {
                    if(await confirmModal('íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
                        const fileLi = e.target.closest('li');
                        const fno = e.target.dataset.fno;

                        const data = await fetchDelete(`/sboard/file/${fno}`);
                        if (data != null){
                            fileLi.remove();
                        }
                    }
                }
            });
        }
    </script>
    <h1 class="mt-4">ê²Œì‹œíŒ</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">[[${boardName}]] ê¸€ë³´ê¸°</li>
    </ol>
    <!-- ë‚´ìš© ì‹œì‘ -->
    <div class="card mb-2">
        <div class="card-header">
            <i class="bi bi-file-earmark-text fs-4"></i>

            <label th:text="${article.title}" class="fw-bold fs-5"></label>
        </div>
        <div class="card-body" id="articleCard">
            <form th:action="@{/article/modify}" id="putForm" method="post" enctype="multipart/form-data">
                <input type="hidden" name="cate" th:value="${pageResponseDTO.cate}">
                <input type="hidden" name="pg" th:value="${pageResponseDTO.pg}">
                <input type="hidden" name="no" th:value="${article.no}">
                <input type="hidden" name="writer" th:value="${article.writer}">
                <input type="hidden" name="user" th:value="${#authentication.principal.user.uid}">
                <!--
                <div class="mb-3">
                    <label for="exampleFormControlInput1" class="form-label">ê¸€ì œëª©</label>
                    <input type="text" class="form-control" id="exampleFormControlInput1" name="title" th:value="${article.title}" readonly>
                </div> -->
                <div class="mb-3">
                    <label for="articleFormControlTextarea1" class="form-label fw-bolder">ê¸€ë‚´ìš©</label>
                    <textarea class="form-control" id="articleFormControlTextarea1" rows="10" name="content" readonly>[[${article.content}]]</textarea>
                </div>
                <div th:if="${article.file > 0}" class="mb-3">
                    <i class="bi bi-paperclip fs-4"></i>
                    <label for="exampleFormControlInput1" class="form-label">ì²¨ë¶€íŒŒì¼</label>
                    <ul class="list-group" id="exampleFormControlInput1">
                        <li th:each="file:${article.fileList}"
                            class="list-group-item d-flex justify-content-between align-items-center">
                            <a th:href="@{/file/download/{fno}(fno=${file.fno})}" class="fileLink"
                               th:data-fno="${file.fno}">[[${file.oName}]]</a>
                            <span class="badge text-bg-primary rounded-pill">[[${file.download}]]</span>
                            <a href="#" class="link-grey visually-hidden removeFile" th:data-fno="${file.fno}"><i class="bi bi-trash3-fill"></i> ì‚­ì œ</a>
                        </li>
                    </ul>
                </div>
                <div class="mb-3 visually-hidden" id="fileUpload">
                    <label for="formFileMultiple" class="form-label">íŒŒì¼ì²¨ë¶€</label>
                    <input class="form-control" type="file" name="files" id="formFileMultiple" multiple>
                </div>
            </form>
        </div>
    </div>
    <div class="text-end" th:if="${#authentication.principal.user.uid == article.writer}">
        <button type="button" class="btn btn-primary" id="articleModify" data-mode="modify">ìˆ˜ì •</button>
        <button type="button" class="btn btn-secondary" id="articleDelete">ì‚­ì œ</button>
    </div>
    <div class="text-center">
        <a th:if="${pageResponseDTO.keyword == null}" th:href="@{/article/list(cate=${pageResponseDTO.cate}, pg=${pageResponseDTO.pg})}"
           class="btn btn-primary">ëª©ë¡</a>
        <a th:if="${pageResponseDTO.keyword != null}" th:href="@{/article/list(cate=${pageResponseDTO.cate}, pg=${pageResponseDTO.pg}, type=${pageResponseDTO.type}, keyword=${pageResponseDTO.keyword})}"
           class="btn btn-primary">ëª©ë¡</a>
        <button class="btn btn-warning" id="iLikeIt" data-like="like"><i class="bi bi-hand-thumbs-up-fill fs-5"></i> ì¶”ì²œ [[${article.heart}]]</button>
    </div>
    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <div id="commentContainer">
        <div class="card mt-3">
            <div class="card-body placeholder-glow" id="commentPlaceholder">
                <div class="d-flex flex-start">
                    <i class="fas fa-user mt-1 me-2"></i>
                    <div class="w-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary fw-bold mb-0 placeholder">

                                <span class="text-dark ms-2"></span>
                            </h6>
                            <div class="ml-auto">
                                <p class="mb-0 placeholder"></p>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="mb-0 placeholder" readonly>
                            </div>
                        </div>
                        <!-- ëŒ“ê¸€ ì‘ì„±ìì™€ í˜„ì¬ ì‚¬ìš©ìê°€ ë™ì¼í•œ ê²½ìš°ì—ë§Œ ì‚­ì œ ë° ìˆ˜ì • ë²„íŠ¼ì„ í‘œì‹œ -->
                        <div class="d-flex justify-content-between align-items-center">
                            <p class="small mb-0" style="color: #aaa;">
                                <a href="#!" class="link-grey placeholder">ìˆ˜ì •</a>
                                <a href="#!" class="link-grey placeholder">ì‚­ì œ</a> â€¢
                            </p>
                            <div class="d-flex flex-row">
                                <i class="fas fa-star text-warning me-2"></i>
                                <i class="far fa-check-circle" style="color: #aaa;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ëŒ“ê¸€ ì“°ê¸° -->
    <form th:action="@{/commentWrite}" method="post" id="commentForm" class="mt-3">
        <input type="hidden" name="parent" th:value="${article.no}">
        <input type="hidden" name="writer" th:value="${#authentication.principal.user.uid}">
        <input type="hidden" name="cate" th:value="${pageResponseDTO.cate}">
        <input type="hidden" name="pg" th:value="${pageResponseDTO.pg}">
        <input type="hidden" name="no" value="0">
        <div class="input-group">
            <span class="input-group-text">ëŒ“ê¸€ ì…ë ¥</span>
            <textarea class="form-control" aria-label="With textarea" rows="5" name="content"></textarea>
        </div>
        <div class="mt-4 mb-4 text-end">
            <button type="button" class="btn btn-secondary">ì·¨ì†Œ</button>
            <input type="submit" class="btn btnComment btn-primary" value="ëŒ“ê¸€ ë“±ë¡">
        </div>
    </form>
    <!-- ë‚´ìš© ë -->
</div>
</html>
